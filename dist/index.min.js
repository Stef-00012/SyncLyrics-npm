var __awaiter=this&&this.__awaiter||function(a,g,d,b){function c(e){return e instanceof d?e:new d(function(f){f(e)})}return new (d||=Promise)(function(e,f){function k(p){try{n(b.next(p))}catch(l){f(l)}}function m(p){try{n(b["throw"](p))}catch(l){f(l)}}function n(p){p.done?e(p.value):c(p.value).then(k,m)}n((b=b.apply(a,g||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});exports.SyncLyrics=void 0;exports.normalize=normalize;
const util_1=require("util"),sleep=(0,util_1.promisify)(setTimeout),logLevels={debug:4,error:3,warn:2,info:1,none:0};
class SyncLyrics{constructor(a){this.logLevel=(null===a||void 0===a?void 0:a.logLevel)||"none";this.instrumentalLyricsIndicator=(null===a||void 0===a?void 0:a.instrumentalLyricsIndicator)||"\uf001";this.sources=(null===a||void 0===a?void 0:a.sources)||["musixmatch","lrclib","netease"];this.cache=(null===a||void 0===a?void 0:a.cache)||new Map;this.saveMusixmatchToken=null===a||void 0===a?void 0:a.saveMusixmatchToken;this.getMusixmatchToken=null===a||void 0===a?void 0:a.getMusixmatchToken;if(0>=this.sources.length)throw Error("SyncLyrics: You must provide atleast one source");
this.lyrics=null;this._fetching=!1;this._trackId=this._fetchingSource=this._fetchingTrackId=null;this._fetchLineSyncedLyricsMusixmatch=this._fetchLineSyncedLyricsMusixmatch.bind(this);this._fetchWordSyncedLyricsMusixmatch=this._fetchWordSyncedLyricsMusixmatch.bind(this);this._fetchPlainLyricsMusixmatch=this._fetchPlainLyricsMusixmatch.bind(this);this._searchLyricsMusixmatch=this._searchLyricsMusixmatch.bind(this);this._fetchLyricsMusixmatch=this._fetchLyricsMusixmatch.bind(this);this.getMusixmatchUsertoken=
this.getMusixmatchUsertoken.bind(this);this.fetchLyricsMusixmatch=this.fetchLyricsMusixmatch.bind(this);this._searchLyricsNetease=this._searchLyricsNetease.bind(this);this._parseNeteaseLyrics=this._parseNeteaseLyrics.bind(this);this._fetchLyricsNetease=this._fetchLyricsNetease.bind(this);this.fetchLyricsNetease=this.fetchLyricsNetease.bind(this);this.fetchLyricsLrclib=this.fetchLyricsLrclib.bind(this);this.parseLyrics=this.parseLyrics.bind(this);this._getLyrics=this._getLyrics.bind(this);this.getTrackId=
this.getTrackId.bind(this);this.getLyrics=this.getLyrics.bind(this);this.debugLog=this.debugLog.bind(this);this.errorLog=this.errorLog.bind(this);this.infoLog=this.infoLog.bind(this);this.warnLog=this.warnLog.bind(this)}getMusixmatchUsertoken(a){return __awaiter(this,void 0,void 0,function*(){var g,d,b,c,e,f;this.infoLog("Getting Musixmatch token...");if(!this.saveMusixmatchToken||!this.getMusixmatchToken)return this.infoLog("Musixmatch token functions are not avaible, skipping..."),null;const k=
yield this.getMusixmatchToken();if(k)return k;this.infoLog("Fetching the token from the API...");try{const m=yield fetch("https://apic-desktop.musixmatch.com/ws/1.1/token.get?user_language=en&app_id=web-desktop-app-v1.0",{redirect:"manual",headers:{cookie:a}});if(301===m.status){this.debugLog("Successfully received the 'set-cookie' redirect response");const h=m.headers.getSetCookie().map(q=>q.split(";").shift()).filter(q=>"unknown"!==q.split("=").pop()).join("; ");this.debugLog("Re-fetching with the cookies...");
return yield this.getMusixmatchUsertoken(h)}if(!m.ok)return this.warnLog(`The usertoken API request failed with the status ${m.status} (${m.statusText})`),null;const n=yield m.json();if(401===(null===(d=null===(g=null===n||void 0===n?void 0:n.message)||void 0===g?void 0:g.header)||void 0===d?void 0:d.status_code)&&"captcha"===(null===(c=null===(b=null===n||void 0===n?void 0:n.message)||void 0===b?void 0:b.header)||void 0===c?void 0:c.hint))return this.warnLog("Musixmatch usertoken endpoint is being ratelimited, retrying in 10 seconds..."),
yield sleep(1E4),this.infoLog("Retrying to fetch the Musixmatch usertken..."),yield this.getMusixmatchUsertoken(a);const p=null===(f=null===(e=null===n||void 0===n?void 0:n.message)||void 0===e?void 0:e.body)||void 0===f?void 0:f.user_token;if(!p)return this.infoLog("The API response did not include the usertoken"),null;const l={cookies:a,usertoken:p,expiresAt:(new Date(Date.now()+6E5)).getTime()};yield this.saveMusixmatchToken(l);this.infoLog("Successfully fetched the usertoken");return l}catch(m){}})}_searchLyricsMusixmatch(a,
g){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,f,k,m,n,p,l,h,q,y,r,v,w,z;if(!a||!g)return null;var x=Number.parseFloat(a.length)/1E3;x=`https://apic-desktop.musixmatch.com/ws/1.1/track.search?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:g.usertoken,q_track:a.track||"",q_artist:a.artist||"",q_album:a.album||"",page_size:20,page:1,q_duration:x||"",s_track_rating:"asc"})}`;try{this.debugLog("Musixmatch search fetch URL:",x);const A=yield fetch(x,{headers:{cookie:g.cookies}});
if(!A.ok)return this.warnLog(`Lyrics fetch request failed with status ${A.status} (${A.statusText}) [Musixmatch - Search]`),null;const u=yield A.json();if(401===(null===(b=null===(d=null===u||void 0===u?void 0:u.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===u||void 0===u?void 0:u.message)||void 0===c?void 0:c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha) [Musixmatch - Search]"),
null;this.debugLog("Musixmatch search results:",null===(k=null===(f=null===u||void 0===u?void 0:u.message)||void 0===f?void 0:f.body)||void 0===k?void 0:k.track_list);if(0>=(null===(p=null===(n=null===(m=null===u||void 0===u?void 0:u.message)||void 0===m?void 0:m.body)||void 0===n?void 0:n.track_list)||void 0===p?void 0:p.length))return this.infoLog("No songs were found [Musixmatch - Search]"),null;const t=null===(q=null===(h=null===(l=null===u||void 0===u?void 0:u.message)||void 0===l?void 0:l.body)||
void 0===h?void 0:h.track_list)||void 0===q?void 0:q.find(F=>{var B,C,D,E;return(null===(B=F.track.track_name)||void 0===B?void 0:B.toLowerCase())===(null===(C=a.track)||void 0===C?void 0:C.toLowerCase())&&(null===(D=F.track.artist_name)||void 0===D?void 0:D.toLowerCase().includes(null===(E=a.artist)||void 0===E?void 0:E.toLowerCase()))});this.debugLog("Musixmatch search filtered track:",t);if(!t)return this.infoLog("No songs were found with the current name and artist [Musixmatch - Search]"),null;
this.debugLog(t);const G=null===(y=null===t||void 0===t?void 0:t.track)||void 0===y?void 0:y.commontrack_id,H=null===(r=null===t||void 0===t?void 0:t.track)||void 0===r?void 0:r.track_id,I=null===(v=null===t||void 0===t?void 0:t.track)||void 0===v?void 0:v.has_lyrics,J=null===(w=null===t||void 0===t?void 0:t.track)||void 0===w?void 0:w.has_subtitles,K=null===(z=null===t||void 0===t?void 0:t.track)||void 0===z?void 0:z.has_richsync;if(!I&&!J&&!K)return null;this.debugLog("Musixmatch commontrack_id",
G);this.debugLog("Musixmatch track_id",H);return{commonTrackId:G,trackId:H,hasLyrics:I,hasLineSyncedLyrics:J,hasWordSyncedLyrics:K}}catch(A){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Search]",A),null}})}_fetchPlainLyricsMusixmatch(a,g){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,f,k,m,n;if(!a||!g)return null;const p=`https://apic-desktop.musixmatch.com/ws/1.1/track.lyrics.get?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:a.usertoken,
commontrack_id:g})}`;try{this.debugLog("Musixmatch lyrics fetch URL:",p);const l=yield fetch(p,{headers:{cookie:a.cookies}});if(!l.ok)return this.warnLog(`Lyrics fetch request failed with status ${l.status} (${l.statusText}) [Musixmatch - Lyrics]`),null;const h=yield l.json();if(401===(null===(b=null===(d=null===h||void 0===h?void 0:h.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===h||void 0===h?void 0:h.message)||void 0===c?void 0:
c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Lyrics]"),null;this.debugLog("Musixmatch track data:",null===(f=null===h||void 0===h?void 0:h.message)||void 0===f?void 0:f.body);const q=null===(n=null===(m=null===(k=null===h||void 0===h?void 0:h.message)||void 0===k?void 0:k.body)||void 0===m?void 0:m.lyrics)||void 0===n?void 0:n.lyrics_body;if(!q)return this.infoLog("Missing Lyrics [Musixmatch - Lyrics]"),
null;this.infoLog("Successfully fetched and cached the plain lyrics [Musixmatch]");return q}catch(l){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Lyrics]",l),null}})}_fetchLineSyncedLyricsMusixmatch(a,g){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,f,k,m,n;if(!a||!g)return null;const p=`https://apic-desktop.musixmatch.com/ws/1.1/track.subtitle.get?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:a.usertoken,commontrack_id:g})}`;try{this.debugLog("Musixmatch synced lyrics fetch URL:",
p);const l=yield fetch(p,{headers:{cookie:a.cookies}});if(!l.ok)return this.warnLog(`Lyrics fetch request failed with status ${l.status} (${l.statusText}) [Musixmatch - Synced Lyrics]`),null;const h=yield l.json();if(401===(null===(b=null===(d=null===h||void 0===h?void 0:h.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===h||void 0===h?void 0:h.message)||void 0===c?void 0:c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Synced Lyrics]"),
null;this.debugLog("Musixmatch track data:",null===(f=null===h||void 0===h?void 0:h.message)||void 0===f?void 0:f.body);const q=null===(n=null===(m=null===(k=null===h||void 0===h?void 0:h.message)||void 0===k?void 0:k.body)||void 0===m?void 0:m.subtitle)||void 0===n?void 0:n.subtitle_body;if(!q)return this.infoLog("Missing Lyrics [Musixmatch - Synced Lyrics]"),null;this.infoLog("Successfully fetched and cached the synced lyrics [Musixmatch]");return q}catch(l){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Synced Lyrics]",
l),null}})}_fetchWordSyncedLyricsMusixmatch(a,g){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,f,k,m,n;if(!a||!g)return null;const p=`https://apic-desktop.musixmatch.com/ws/1.1/track.richsync.get?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:a.usertoken,track_id:g})}`;try{this.debugLog("Musixmatch lyrics fetch URL:",p);const l=yield fetch(p,{headers:{cookie:a.cookies}});if(!l.ok)return this.warnLog(`Lyrics fetch request failed with status ${l.status} (${l.statusText}) [Musixmatch - Word Synced Lyrics]`),
null;const h=yield l.json();if(401===(null===(b=null===(d=null===h||void 0===h?void 0:h.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===h||void 0===h?void 0:h.message)||void 0===c?void 0:c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Word Synced Lyrics]"),null;this.debugLog("Musixmatch track data:",null===(f=null===h||void 0===h?void 0:
h.message)||void 0===f?void 0:f.body);let q=null===(n=null===(m=null===(k=null===h||void 0===h?void 0:h.message)||void 0===k?void 0:k.body)||void 0===m?void 0:m.richsync)||void 0===n?void 0:n.richsync_body;if(!q||0>=q.length)return this.infoLog("Missing Lyrics [Musixmatch - Word Synced Lyrics]"),null;q=JSON.parse(q);const y=q.map(r=>{const v=r.ts,w=r.te,z=r.x;r=r.l.map(x=>({character:x.c,time:x.o}));return{end:w,lyric:z,start:v,syncedLyric:r}});this.infoLog("Successfully fetched and cached the synced lyrics [Musixmatch]");
return y}catch(l){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Word Synced Lyrics]",l),null}})}_fetchLyricsMusixmatch(a,g,d,b,c,e,f){return __awaiter(this,void 0,void 0,function*(){if(!a||!b&&!d||!g||!c&&!e&&!f)return null;const k={plain:null,lineSynced:null,wordSynced:null};c&&b&&(k.plain=yield this._fetchPlainLyricsMusixmatch(g,b));e&&b&&(k.lineSynced=yield this._fetchLineSyncedLyricsMusixmatch(g,b));f&&b&&(k.wordSynced=yield this._fetchWordSyncedLyricsMusixmatch(g,
d));return k})}_searchLyricsNetease(a){return __awaiter(this,void 0,void 0,function*(){var g,d,b,c,e;const f=`https://music.xianqiao.wang/neteaseapiv2/search?${new URLSearchParams({limit:10,type:1,keywords:`${a.track} ${a.artist}`})}`;try{this.debugLog("Netease search fetch URL:",f);const k=yield fetch(f,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0"}});if(!k.ok)return this.warnLog(`Lyrics fetch request failed with status ${k.status} (${k.statusText}) [Netease - Search]`),
null;const m=yield k.json();if(null===(g=null===m||void 0===m?void 0:m.result)||void 0===g||!g.songs||0>=(null===(b=null===(d=null===m||void 0===m?void 0:m.result)||void 0===d?void 0:d.songs)||void 0===b?void 0:b.length))return this.infoLog("No songs were found [Netease - Search]"),null;const n=null===(e=null===(c=null===m||void 0===m?void 0:m.result)||void 0===c?void 0:c.songs)||void 0===e?void 0:e.find(l=>{var h,q;return(null===(h=l.name)||void 0===h?void 0:h.toLowerCase())===(null===(q=a.track)||
void 0===q?void 0:q.toLowerCase())&&(l.artists.some(y=>{var r,v,w;return null===(v=null===(r=y.name)||void 0===r?void 0:r.toLowerCase())||void 0===v?void 0:v.includes(null===(w=a.artist)||void 0===w?void 0:w.toLowerCase())})||l.artists.some(y=>{var r,v,w,z,x;return null===(w=null===(v=null===(r=y.name)||void 0===r?void 0:r.toLowerCase())||void 0===v?void 0:v.replace(/-/g," "))||void 0===w?void 0:w.includes(null===(x=null===(z=a.artist)||void 0===z?void 0:z.toLowerCase())||void 0===x?void 0:x.replace(/-/g,
" "))}))});this.debugLog("Netease search filtered track:",n);if(!n)return this.infoLog("No songs were found with the current name and artist [Netease - Search]"),null;const p=n.id;this.debugLog("Neteasw track ID",p);return p}catch(k){return this.errorLog("Something went wrong while fetching the lyrics [Netease - Search]",k),null}})}_fetchLyricsNetease(a,g){return __awaiter(this,void 0,void 0,function*(){var d;if(!a||!g)return null;const b=`https://music.xianqiao.wang/neteaseapiv2/lyric?${new URLSearchParams({id:g})}`;
try{this.debugLog("Netease lyrics fetch URL:",b);const c=yield fetch(b,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0"}});if(!c.ok)return this.warnLog(`Lyrics fetch request failed with status ${c.status} (${c.statusText}) [Netease - Lyrics]`),null;const e=yield c.json();this.debugLog("Netease track data:",e);let f=null===(d=null===e||void 0===e?void 0:e.lrc)||void 0===d?void 0:d.lyric;if(!f)return this.infoLog("Missing Lyrics [Netease - Lyrics]"),
null;f=this._parseNeteaseLyrics(f);this.infoLog("Successfully fetched and cached the synced lyrics [Netease]");return f}catch(c){return this.errorLog("Something went wrong while fetching the lyrics [Netease - Lyrics]",c),null}})}_parseNeteaseLyrics(a){a=a.split(/\r?\n/).map(e=>e.trim());const g=[],d=RegExp("^(\\s?\u4f5c?\\s*\u8bcd|\\s?\u4f5c?\\s*\u66f2|\\s?\u7f16\\s*\u66f2?|\\s?\u76d1\\s*\u5236?|.*\u7f16\u5199|.*\u548c\u97f3|.*\u548c\u58f0|.*\u5408\u58f0|.*\u63d0\u7434|.*\u5f55|.*\u5de5\u7a0b|.*\u5de5\u4f5c\u5ba4|.*\u8bbe\u8ba1|.*\u526a\u8f91|.*\u5236\u4f5c|.*\u53d1\u884c|.*\u51fa\u54c1|.*\u540e\u671f|.*\u6df7\u97f3|.*\u7f29\u6df7|\u539f\u5531|\u7ffb\u5531|\u9898\u5b57|\u6587\u6848|\u6d77\u62a5|\u53e4\u7b5d|\u4e8c\u80e1|\u94a2\u7434|\u5409\u4ed6|\u8d1d\u65af|\u7b1b\u5b50|\u9f13|\u5f26\u4e50| \u4eba\u58f0 |lrc|publish|vocal|guitar|program|produce|write|mix).*(:|\uff1a)",
"i");for(let e=0;e<a.length;e++){var b=a[e].match(/(\[.*?\])|([^\[\]]+)/g);if(!b||1===b.length)continue;let f=-1;for(var c=0;c<b.length;c++)if(!b[c].endsWith("]")){f=c;break}c="";-1<f&&(c=b.splice(f,1)[0],c=c.charAt(0).toUpperCase()+normalize(c.slice(1)));b=b[0];d.test(c)||g.push(`${b} ${c||""}`)}return g.join("\n")}fetchLyricsLrclib(a){return __awaiter(this,void 0,void 0,function*(){var g,d;if(a){this.infoLog(`Fetching the lyrics for "${a.track}" from "${a.album}" from "${a.artist}" (${this._trackId}) [LRCLIB]`);
var b=new URLSearchParams({track_name:a.track,artist_name:a.artist,album_name:a.album,q:a.track});try{const c=yield fetch(`https://lrclib.net/api/search?${b}`,{headers:{"Lrclib-Client":"SyncLyrics (https://github.com/Stef-00012/SyncLyrics)","User-Agent":"SyncLyrics (https://github.com/Stef-00012/SyncLyrics)"}});if(!c.ok)return this.warnLog(`Lyrics fetch request failed with status ${c.status} (${c.statusText}) [LRCLIB]`),null;const e=yield c.json();this.debugLog("lrclib.net results:",e);const f=e.find(k=>
{var m,n,p,l;return(null===(m=k.artistName)||void 0===m?void 0:m.toLowerCase().includes(null===(n=a.artist)||void 0===n?void 0:n.toLowerCase()))&&(null===(p=k.trackName)||void 0===p?void 0:p.toLowerCase())===(null===(l=a.track)||void 0===l?void 0:l.toLowerCase())});this.debugLog("lrclib filtered track:",f);if(!f||(!f.syncedLyrics||0>=(null===(g=f.syncedLyrics)||void 0===g?void 0:g.length))&&(!f.plainLyrics||0>=(null===(d=f.plainLyrics)||void 0===d?void 0:d.length)))return this.infoLog("The fetched song does not have lyrics [LRCLIB]"),
null;this.infoLog("Successfully fetched and cached the lyrics [LRCLIB]");return{source:"lrclib.net",plain:null===f||void 0===f?void 0:f.plainLyrics,lineSynced:null===f||void 0===f?void 0:f.syncedLyrics,wordSynced:null}}catch(c){return this.errorLog("Something went wrong while fetching the lyrics [LRCLIB]",c),null}}})}fetchLyricsMusixmatch(a){return __awaiter(this,void 0,void 0,function*(){if(a){var g=yield this.getMusixmatchUsertoken();this.debugLog("Musixmatch token data:",g);if(!g)return null;this.infoLog(`Fetching the lyrics for "${a.track}" from "${a.album}" from "${a.artist}" (${this._trackId}) [Musixmatch]`);
var d=yield this._searchLyricsMusixmatch(a,g);if(!d||!d.hasLyrics&&!d.hasLineSyncedLyrics&&!d.hasWordSyncedLyrics||!d.commonTrackId&&!d.trackId)return this.infoLog("Missing both commontrack_id and track_id [Musixmatch - Search]"),null;g=yield this._fetchLyricsMusixmatch(a,g,d.trackId,d.commonTrackId,d.hasLyrics,d.hasLineSyncedLyrics,d.hasWordSyncedLyrics);return Object.assign({source:"Musixmatch"},g)}})}fetchLyricsNetease(a){return __awaiter(this,void 0,void 0,function*(){if(a){var g=yield this._searchLyricsNetease(a);
return g?{source:"Netease",lineSynced:yield this._fetchLyricsNetease(a,g),plain:null,wordSynced:null}:(this.infoLog("Missing track ID [Netease - Search]"),null)}})}_getLyrics(a){return __awaiter(this,void 0,void 0,function*(){if(this._fetching&&this._fetchingTrackId===this._trackId)return this.warnLog(`Already fetching from the source "${this._fetchingSource}" (Track ID: "${this._fetchingTrackId}")`),null;const g={musixmatch:["plain","line","word"],lrclib:["plain","line"],netease:["line"]},d={musixmatch:this.fetchLyricsMusixmatch,
lrclib:this.fetchLyricsLrclib,netease:this.fetchLyricsNetease};var b=this.sources||["musixmatch","lrclib","netease"];const c={plain:{source:null,lyrics:null},lineSynced:{source:null,lyrics:null},wordSynced:{source:null,lyrics:null}};b.every(e=>!Object.keys(d).includes(e))&&(b=["musixmatch","lrclib","netease"]);a:for(const e of b){this.infoLog(`Trying to fetch the lyrics from the source "${e}"`);if(!("musixmatch"!==e||this.saveMusixmatchToken&&this.getMusixmatchToken)){this.infoLog("Musixmatch token functions are not avaible, skipping...");
continue}b=0;const f=g[e];for(const k of f)if("plain"===k&&c.plain.lyrics&&b++,"line"===k&&c.lineSynced.lyrics&&b++,"word"===k&&c.wordSynced.lyrics&&b++,b>=f.length)continue a;if(Object.keys(d).includes(e)){if(this._fetching=!0,this._fetchingSource=e,this._fetchingTrackId=this._trackId,b=yield d[e](a))(null===b||void 0===b?0:b.plain)&&!c.plain.lyrics&&(c.plain.lyrics=b.plain,c.plain.source=b.source),(null===b||void 0===b?0:b.lineSynced)&&!c.lineSynced.lyrics&&(c.lineSynced.lyrics=b.lineSynced,c.lineSynced.source=
b.source),(null===b||void 0===b?0:b.wordSynced)&&!c.wordSynced.lyrics&&(c.wordSynced.lyrics=b.wordSynced,c.wordSynced.source=b.source)}else this.infoLog(`The source "${e}" doesn't exist, skipping...`)}return c})}getLyrics(a,g){return __awaiter(this,void 0,void 0,function*(){if(!((null===a||void 0===a?0:a.track)||(null===a||void 0===a?0:a.artist)||(null===a||void 0===a?0:a.album)||(null===a||void 0===a?0:a.trackId)))throw Error("SyncLyrics (getlyrics): At least one of track, artist, album or trackId must be present");
this._trackId=a.trackId||btoa(unescape(encodeURIComponent(`${a.track||""}-${a.artist||""}-${a.album||""}`)));const d=g?null:this.cache.get(this._trackId),b=d||(yield this._getLyrics(a));!g&&(!this.cache.has(this._trackId)||(null===b||void 0===b?0:b.plain.lyrics)&&(null===d||void 0===d||!d.plain.lyrics)||(null===b||void 0===b?0:b.lineSynced.lyrics)&&(null===d||void 0===d||!d.lineSynced.lyrics)||(null===b||void 0===b?0:b.wordSynced.lyrics)&&(null===d||void 0===d||!d.wordSynced.lyrics))&&this.cache.set(this._trackId,
b||{plain:{lyrics:null,source:null},lineSynced:{lyrics:null,source:null},wordSynced:{lyrics:null,source:null}});if(!b)return{trackId:this._trackId,lyrics:{plain:{lyrics:null,source:null},lineSynced:{lyrics:null,source:null,parse:this.parseLyrics},wordSynced:{lyrics:null,source:null}},track:a.track,artist:a.artist,album:a.album,cached:!1};this.lyrics=b.lineSynced.lyrics;return{trackId:this._trackId,lyrics:Object.assign(Object.assign({},b),{lineSynced:Object.assign(Object.assign({},b.lineSynced),{parse:this.parseLyrics})}),
track:a.track,artist:a.artist,album:a.album,cached:!!d}})}parseLyrics(a=this.lyrics){a=null===a||void 0===a?void 0:a.split("\n");if(!a)return null;const g=[];let d;for(const f in a){var b=a[f].split(" ");const k=b.shift().replace(/[\[\]]/g,"");b=b.join(" ");var c=k.split(":")[0],e=k.split(":")[1];c=60*Number.parseFloat(c)+Number.parseFloat(e);e=this.instrumentalLyricsIndicator||"\uf001 ";"0"===f&&3<c&&e&&g.push({time:0,text:e});0<b.length?(d=k,g.push({time:c,text:b})):e&&(!d||3<d-k)&&(d=k,g.push({time:c,
text:e}))}return g}getTrackId(a){return a.trackId?a.trackId:btoa(unescape(encodeURIComponent(`${a.track||""}-${a.artist||""}-${a.album||""}`)))}warnLog(...a){(logLevels[this.logLevel]||0)<logLevels.warn||console.warn("\u001b[33;1mWARNING:\u001b[0m",...a)}debugLog(...a){(logLevels[this.logLevel]||0)<logLevels.debug||console.debug("\u001b[35;1mDEBUG:\u001b[0m",...a)}errorLog(...a){(logLevels[this.logLevel]||0)<logLevels.debug||console.debug("\u001b[35;1mDEBUG:\u001b[0m",...a)}infoLog(...a){(logLevels[this.logLevel]||
0)<logLevels.info||console.info("\u001b[34;1mINFO:\u001b[0m",...a)}}exports.SyncLyrics=SyncLyrics;
function normalize(a){return a.replace(/\uff08/g,"(").replace(/\uff09/g,")").replace(/\u3010/g,"[").replace(/\u3011/g,"]").replace(/\u3002/g,". ").replace(/\uff1b/g,"; ").replace(/\uff1a/g,": ").replace(/\uff1f/g,"? ").replace(/\uff01/g,"! ").replace(/\u3001|\uff0c/g,", ").replace(/\u2018|\u2019|\u2032|\uff07/g,"'").replace(/\u201c|\u201d/g,'"').replace(/\u301c/g,"~").replace(/\u00b7|\u30fb/g,"\u2022").replace(/\s+/g," ").trim()};
