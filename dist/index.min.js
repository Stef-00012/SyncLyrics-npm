var __awaiter=this&&this.__awaiter||function(a,f,d,b){function c(e){return e instanceof d?e:new d(function(g){g(e)})}return new (d||=Promise)(function(e,g){function h(p){try{n(b.next(p))}catch(m){g(m)}}function l(p){try{n(b["throw"](p))}catch(m){g(m)}}function n(p){p.done?e(p.value):c(p.value).then(h,l)}n((b=b.apply(a,f||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});exports.SyncLyrics=exports.logLevels=exports.lyricType=exports.sources=void 0;exports.normalize=normalize;
const util_1=require("util"),sleep=(0,util_1.promisify)(setTimeout);exports.sources=["musixmatch","lrclib","netease"];exports.lyricType=["plain","lineSynced","wordSynced"];exports.logLevels={debug:4,error:3,warn:2,info:1,none:0};
class SyncLyrics{constructor(a){if("string"===typeof(null===a||void 0===a?void 0:a.logLevel)&&!Object.keys(exports.logLevels).includes(a.logLevel))throw Error(`SyncLyrics: logLevel must be one of "${Object.keys(exports.logLevels).join('" | "')}"`);if((null===a||void 0===a?0:a.instrumentalLyricsIndicator)&&"string"!==typeof a.instrumentalLyricsIndicator)throw Error("SyncLyrics: instrumentalLyricsIndicator must be a string");if((null===a||void 0===a?0:a.sources)&&(!Array.isArray(a.sources)||0>=a.sources.length))throw Error('SyncLyrics: sources must be an array with atleast one of "musixmatch" | "lrclib" | "netease"');
if((null===a||void 0===a?0:a.cache)&&("function"!==typeof a.cache.get||"function"!==typeof a.cache.set||"function"!==typeof a.cache.has))throw Error("SyncLyrics: cache must have .get, .set and .has methods");if((null===a||void 0===a?0:a.saveMusixmatchToken)&&"function"!==typeof a.saveMusixmatchToken)throw Error("SyncLyrics: saveMusixmatchToken must be a function");if((null===a||void 0===a?0:a.getMusixmatchToken)&&"function"!==typeof a.getMusixmatchToken)throw Error("SyncLyrics: getMusixmatchToken must be a function");
this.logLevel=(null===a||void 0===a?void 0:a.logLevel)||"none";this.instrumentalLyricsIndicator=(null===a||void 0===a?void 0:a.instrumentalLyricsIndicator)||"\uf001";this.sources=(null===a||void 0===a?void 0:a.sources)||["musixmatch","lrclib","netease"];this.cache=(null===a||void 0===a?void 0:a.cache)||new Map;this.saveMusixmatchToken=null===a||void 0===a?void 0:a.saveMusixmatchToken;this.getMusixmatchToken=null===a||void 0===a?void 0:a.getMusixmatchToken;this._trackId=this.lyrics=null;this._fetching=
!1;this._fetchLineSyncedLyricsMusixmatch=this._fetchLineSyncedLyricsMusixmatch.bind(this);this._fetchWordSyncedLyricsMusixmatch=this._fetchWordSyncedLyricsMusixmatch.bind(this);this._fetchPlainLyricsMusixmatch=this._fetchPlainLyricsMusixmatch.bind(this);this._searchLyricsMusixmatch=this._searchLyricsMusixmatch.bind(this);this._fetchLyricsMusixmatch=this._fetchLyricsMusixmatch.bind(this);this.getMusixmatchUsertoken=this.getMusixmatchUsertoken.bind(this);this.fetchLyricsMusixmatch=this.fetchLyricsMusixmatch.bind(this);
this._searchLyricsNetease=this._searchLyricsNetease.bind(this);this._parseNeteaseLyrics=this._parseNeteaseLyrics.bind(this);this._fetchLyricsNetease=this._fetchLyricsNetease.bind(this);this.fetchLyricsNetease=this.fetchLyricsNetease.bind(this);this.fetchLyricsLrclib=this.fetchLyricsLrclib.bind(this);this.parseLyrics=this.parseLyrics.bind(this);this._getLyrics=this._getLyrics.bind(this);this.getTrackId=this.getTrackId.bind(this);this.getLyrics=this.getLyrics.bind(this);this.debugLog=this.debugLog.bind(this);
this.errorLog=this.errorLog.bind(this);this.infoLog=this.infoLog.bind(this);this.warnLog=this.warnLog.bind(this)}getMusixmatchUsertoken(a){return __awaiter(this,void 0,void 0,function*(){var f,d,b,c,e,g;this.infoLog("Getting Musixmatch token...");if(!this.saveMusixmatchToken||!this.getMusixmatchToken)return this.infoLog("Musixmatch token functions are not avaible, skipping..."),null;const h=yield this.getMusixmatchToken();if(h)return h;this.infoLog("Fetching the token from the API...");try{const l=
yield fetch("https://apic-desktop.musixmatch.com/ws/1.1/token.get?user_language=en&app_id=web-desktop-app-v1.0",{redirect:"manual",headers:{cookie:a}});if(301===l.status){this.debugLog("Successfully received the 'set-cookie' redirect response");const k=l.headers.getSetCookie().map(q=>q.split(";").shift()).filter(q=>"unknown"!==q.split("=").pop()).join("; ");this.debugLog("Re-fetching with the cookies...");return yield this.getMusixmatchUsertoken(k)}if(!l.ok)return this.warnLog(`The usertoken API request failed with the status ${l.status} (${l.statusText})`),
null;const n=yield l.json();if(401===(null===(d=null===(f=null===n||void 0===n?void 0:n.message)||void 0===f?void 0:f.header)||void 0===d?void 0:d.status_code)&&"captcha"===(null===(c=null===(b=null===n||void 0===n?void 0:n.message)||void 0===b?void 0:b.header)||void 0===c?void 0:c.hint))return this.warnLog("Musixmatch usertoken endpoint is being ratelimited, retrying in 10 seconds..."),yield sleep(1E4),this.infoLog("Retrying to fetch the Musixmatch usertken..."),yield this.getMusixmatchUsertoken(a);
const p=null===(g=null===(e=null===n||void 0===n?void 0:n.message)||void 0===e?void 0:e.body)||void 0===g?void 0:g.user_token;if(!p)return this.infoLog("The API response did not include the usertoken"),null;const m={cookies:a,usertoken:p,expiresAt:(new Date(Date.now()+6E5)).getTime()};yield this.saveMusixmatchToken(m);this.infoLog("Successfully fetched the usertoken");return m}catch(l){}})}_searchLyricsMusixmatch(a,f){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,g,h,l,n,p,m,k,q,y,r,
v,w,z;if(!a||!f)return null;var x=Number.parseFloat(a.length)/1E3;x=`https://apic-desktop.musixmatch.com/ws/1.1/track.search?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:f.usertoken,q_track:a.track||"",q_artist:a.artist||"",q_album:a.album||"",page_size:20,page:1,q_duration:x||"",s_track_rating:"asc"})}`;try{this.debugLog("Musixmatch search fetch URL:",x);const A=yield fetch(x,{headers:{cookie:f.cookies}});if(!A.ok)return this.warnLog(`Lyrics fetch request failed with status ${A.status} (${A.statusText}) [Musixmatch - Search]`),
null;const u=yield A.json();if(401===(null===(b=null===(d=null===u||void 0===u?void 0:u.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===u||void 0===u?void 0:u.message)||void 0===c?void 0:c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha) [Musixmatch - Search]"),null;this.debugLog("Musixmatch search results:",null===(h=null===(g=null===u||void 0===u?void 0:
u.message)||void 0===g?void 0:g.body)||void 0===h?void 0:h.track_list);if(0>=(null===(p=null===(n=null===(l=null===u||void 0===u?void 0:u.message)||void 0===l?void 0:l.body)||void 0===n?void 0:n.track_list)||void 0===p?void 0:p.length))return this.infoLog("No songs were found [Musixmatch - Search]"),null;const t=null===(q=null===(k=null===(m=null===u||void 0===u?void 0:u.message)||void 0===m?void 0:m.body)||void 0===k?void 0:k.track_list)||void 0===q?void 0:q.find(F=>{var B,C,D,E;return(null===(B=
F.track.track_name)||void 0===B?void 0:B.toLowerCase())===(null===(C=a.track)||void 0===C?void 0:C.toLowerCase())&&(null===(D=F.track.artist_name)||void 0===D?void 0:D.toLowerCase().includes(null===(E=a.artist)||void 0===E?void 0:E.toLowerCase()))});this.debugLog("Musixmatch search filtered track:",t);if(!t)return this.infoLog("No songs were found with the current name and artist [Musixmatch - Search]"),null;this.debugLog(t);const G=null===(y=null===t||void 0===t?void 0:t.track)||void 0===y?void 0:
y.commontrack_id,H=null===(r=null===t||void 0===t?void 0:t.track)||void 0===r?void 0:r.track_id,I=null===(v=null===t||void 0===t?void 0:t.track)||void 0===v?void 0:v.has_lyrics,J=null===(w=null===t||void 0===t?void 0:t.track)||void 0===w?void 0:w.has_subtitles,K=null===(z=null===t||void 0===t?void 0:t.track)||void 0===z?void 0:z.has_richsync;if(!I&&!J&&!K)return null;this.debugLog("Musixmatch commontrack_id",G);this.debugLog("Musixmatch track_id",H);return{commonTrackId:G,trackId:H,hasLyrics:I,hasLineSyncedLyrics:J,
hasWordSyncedLyrics:K}}catch(A){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Search]",A),null}})}_fetchPlainLyricsMusixmatch(a,f){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,g,h,l,n;if(!a||!f)return null;const p=`https://apic-desktop.musixmatch.com/ws/1.1/track.lyrics.get?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:a.usertoken,commontrack_id:f})}`;try{this.debugLog("Musixmatch lyrics fetch URL:",p);const m=yield fetch(p,{headers:{cookie:a.cookies}});
if(!m.ok)return this.warnLog(`Lyrics fetch request failed with status ${m.status} (${m.statusText}) [Musixmatch - Lyrics]`),null;const k=yield m.json();if(401===(null===(b=null===(d=null===k||void 0===k?void 0:k.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===k||void 0===k?void 0:k.message)||void 0===c?void 0:c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Lyrics]"),
null;this.debugLog("Musixmatch track data:",null===(g=null===k||void 0===k?void 0:k.message)||void 0===g?void 0:g.body);const q=null===(n=null===(l=null===(h=null===k||void 0===k?void 0:k.message)||void 0===h?void 0:h.body)||void 0===l?void 0:l.lyrics)||void 0===n?void 0:n.lyrics_body;if(!q)return this.infoLog("Missing Lyrics [Musixmatch - Lyrics]"),null;this.infoLog("Successfully fetched and cached the plain lyrics [Musixmatch]");return q}catch(m){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Lyrics]",
m),null}})}_fetchLineSyncedLyricsMusixmatch(a,f){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,g,h,l,n;if(!a||!f)return null;const p=`https://apic-desktop.musixmatch.com/ws/1.1/track.subtitle.get?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:a.usertoken,commontrack_id:f})}`;try{this.debugLog("Musixmatch synced lyrics fetch URL:",p);const m=yield fetch(p,{headers:{cookie:a.cookies}});if(!m.ok)return this.warnLog(`Lyrics fetch request failed with status ${m.status} (${m.statusText}) [Musixmatch - Synced Lyrics]`),
null;const k=yield m.json();if(401===(null===(b=null===(d=null===k||void 0===k?void 0:k.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===k||void 0===k?void 0:k.message)||void 0===c?void 0:c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Synced Lyrics]"),null;this.debugLog("Musixmatch track data:",null===(g=null===k||void 0===k?void 0:k.message)||
void 0===g?void 0:g.body);const q=null===(n=null===(l=null===(h=null===k||void 0===k?void 0:k.message)||void 0===h?void 0:h.body)||void 0===l?void 0:l.subtitle)||void 0===n?void 0:n.subtitle_body;if(!q)return this.infoLog("Missing Lyrics [Musixmatch - Synced Lyrics]"),null;this.infoLog("Successfully fetched and cached the synced lyrics [Musixmatch]");return q}catch(m){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Synced Lyrics]",m),null}})}_fetchWordSyncedLyricsMusixmatch(a,
f){return __awaiter(this,void 0,void 0,function*(){var d,b,c,e,g,h,l,n;if(!a||!f)return null;const p=`https://apic-desktop.musixmatch.com/ws/1.1/track.richsync.get?${new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:a.usertoken,track_id:f})}`;try{this.debugLog("Musixmatch lyrics fetch URL:",p);const m=yield fetch(p,{headers:{cookie:a.cookies}});if(!m.ok)return this.warnLog(`Lyrics fetch request failed with status ${m.status} (${m.statusText}) [Musixmatch - Word Synced Lyrics]`),null;const k=
yield m.json();if(401===(null===(b=null===(d=null===k||void 0===k?void 0:k.message)||void 0===d?void 0:d.header)||void 0===b?void 0:b.status_code)&&"captcha"===(null===(e=null===(c=null===k||void 0===k?void 0:k.message)||void 0===c?void 0:c.header)||void 0===e?void 0:e.hint))return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Word Synced Lyrics]"),null;this.debugLog("Musixmatch track data:",null===(g=null===k||void 0===k?void 0:k.message)||
void 0===g?void 0:g.body);let q=null===(n=null===(l=null===(h=null===k||void 0===k?void 0:k.message)||void 0===h?void 0:h.body)||void 0===l?void 0:l.richsync)||void 0===n?void 0:n.richsync_body;if(!q||0>=q.length)return this.infoLog("Missing Lyrics [Musixmatch - Word Synced Lyrics]"),null;q=JSON.parse(q);const y=q.map(r=>{const v=r.ts,w=r.te,z=r.x;r=r.l.map(x=>({character:x.c,time:x.o}));return{end:w,lyric:z,start:v,syncedLyric:r}});this.infoLog("Successfully fetched and cached the synced lyrics [Musixmatch]");
return y}catch(m){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Word Synced Lyrics]",m),null}})}_fetchLyricsMusixmatch(a,f,d,b,c,e,g,h){return __awaiter(this,void 0,void 0,function*(){if(!a||!b&&!d||!f||!c&&!e&&!g)return null;const l={plain:null,lineSynced:null,wordSynced:null};c&&b&&h.includes("plain")&&(l.plain=yield this._fetchPlainLyricsMusixmatch(f,b));e&&b&&h.includes("lineSynced")&&(l.lineSynced=yield this._fetchLineSyncedLyricsMusixmatch(f,b));g&&b&&h.includes("wordSynced")&&
(l.wordSynced=yield this._fetchWordSyncedLyricsMusixmatch(f,d));return l})}_searchLyricsNetease(a){return __awaiter(this,void 0,void 0,function*(){var f,d,b,c,e;const g=`https://music.xianqiao.wang/neteaseapiv2/search?${new URLSearchParams({limit:10,type:1,keywords:`${a.track} ${a.artist}`})}`;try{this.debugLog("Netease search fetch URL:",g);const h=yield fetch(g,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0"}});if(!h.ok)return this.warnLog(`Lyrics fetch request failed with status ${h.status} (${h.statusText}) [Netease - Search]`),
null;const l=yield h.json();if(null===(f=null===l||void 0===l?void 0:l.result)||void 0===f||!f.songs||0>=(null===(b=null===(d=null===l||void 0===l?void 0:l.result)||void 0===d?void 0:d.songs)||void 0===b?void 0:b.length))return this.infoLog("No songs were found [Netease - Search]"),null;const n=null===(e=null===(c=null===l||void 0===l?void 0:l.result)||void 0===c?void 0:c.songs)||void 0===e?void 0:e.find(m=>{var k,q;return(null===(k=m.name)||void 0===k?void 0:k.toLowerCase())===(null===(q=a.track)||
void 0===q?void 0:q.toLowerCase())&&(m.artists.some(y=>{var r,v,w;return null===(v=null===(r=y.name)||void 0===r?void 0:r.toLowerCase())||void 0===v?void 0:v.includes(null===(w=a.artist)||void 0===w?void 0:w.toLowerCase())})||m.artists.some(y=>{var r,v,w,z,x;return null===(w=null===(v=null===(r=y.name)||void 0===r?void 0:r.toLowerCase())||void 0===v?void 0:v.replace(/-/g," "))||void 0===w?void 0:w.includes(null===(x=null===(z=a.artist)||void 0===z?void 0:z.toLowerCase())||void 0===x?void 0:x.replace(/-/g,
" "))}))});this.debugLog("Netease search filtered track:",n);if(!n)return this.infoLog("No songs were found with the current name and artist [Netease - Search]"),null;const p=n.id;this.debugLog("Neteasw track ID",p);return p}catch(h){return this.errorLog("Something went wrong while fetching the lyrics [Netease - Search]",h),null}})}_fetchLyricsNetease(a,f){return __awaiter(this,void 0,void 0,function*(){var d;if(!a||!f)return null;const b=`https://music.xianqiao.wang/neteaseapiv2/lyric?${new URLSearchParams({id:f})}`;
try{this.debugLog("Netease lyrics fetch URL:",b);const c=yield fetch(b,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0"}});if(!c.ok)return this.warnLog(`Lyrics fetch request failed with status ${c.status} (${c.statusText}) [Netease - Lyrics]`),null;const e=yield c.json();this.debugLog("Netease track data:",e);let g=null===(d=null===e||void 0===e?void 0:e.lrc)||void 0===d?void 0:d.lyric;if(!g)return this.infoLog("Missing Lyrics [Netease - Lyrics]"),
null;g=this._parseNeteaseLyrics(g);this.infoLog("Successfully fetched and cached the synced lyrics [Netease]");return g}catch(c){return this.errorLog("Something went wrong while fetching the lyrics [Netease - Lyrics]",c),null}})}_parseNeteaseLyrics(a){a=a.split(/\r?\n/).map(e=>e.trim());const f=[],d=RegExp("^(\\s?\u4f5c?\\s*\u8bcd|\\s?\u4f5c?\\s*\u66f2|\\s?\u7f16\\s*\u66f2?|\\s?\u76d1\\s*\u5236?|.*\u7f16\u5199|.*\u548c\u97f3|.*\u548c\u58f0|.*\u5408\u58f0|.*\u63d0\u7434|.*\u5f55|.*\u5de5\u7a0b|.*\u5de5\u4f5c\u5ba4|.*\u8bbe\u8ba1|.*\u526a\u8f91|.*\u5236\u4f5c|.*\u53d1\u884c|.*\u51fa\u54c1|.*\u540e\u671f|.*\u6df7\u97f3|.*\u7f29\u6df7|\u539f\u5531|\u7ffb\u5531|\u9898\u5b57|\u6587\u6848|\u6d77\u62a5|\u53e4\u7b5d|\u4e8c\u80e1|\u94a2\u7434|\u5409\u4ed6|\u8d1d\u65af|\u7b1b\u5b50|\u9f13|\u5f26\u4e50| \u4eba\u58f0 |lrc|publish|vocal|guitar|program|produce|write|mix).*(:|\uff1a)",
"i");for(let e=0;e<a.length;e++){var b=a[e].match(/(\[.*?\])|([^\[\]]+)/g);if(!b||1===b.length)continue;let g=-1;for(var c=0;c<b.length;c++)if(!b[c].endsWith("]")){g=c;break}c="";-1<g&&(c=b.splice(g,1)[0],c=c.charAt(0).toUpperCase()+normalize(c.slice(1)));b=b[0];d.test(c)||f.push(`${b} ${c||""}`)}return f.join("\n")}fetchLyricsLrclib(a,f){return __awaiter(this,void 0,void 0,function*(){var d,b;if(!a||!f.includes("plain")&&!f.includes("lineSynced"))return null;this.infoLog(`Fetching the lyrics for "${a.track}" from "${a.album}" from "${a.artist}" (${this._trackId}) [LRCLIB]`);
const c=new URLSearchParams({track_name:a.track,artist_name:a.artist,album_name:a.album,q:a.track});try{const e=yield fetch(`https://lrclib.net/api/search?${c}`,{headers:{"Lrclib-Client":"SyncLyrics (https://github.com/Stef-00012/SyncLyrics)","User-Agent":"SyncLyrics (https://github.com/Stef-00012/SyncLyrics)"}});if(!e.ok)return this.warnLog(`Lyrics fetch request failed with status ${e.status} (${e.statusText}) [LRCLIB]`),null;const g=yield e.json();this.debugLog("lrclib.net results:",g);const h=
g.find(l=>{var n,p,m,k;return(null===(n=l.artistName)||void 0===n?void 0:n.toLowerCase().includes(null===(p=a.artist)||void 0===p?void 0:p.toLowerCase()))&&(null===(m=l.trackName)||void 0===m?void 0:m.toLowerCase())===(null===(k=a.track)||void 0===k?void 0:k.toLowerCase())});this.debugLog("lrclib filtered track:",h);if(!h||(!h.syncedLyrics||0>=(null===(d=h.syncedLyrics)||void 0===d?void 0:d.length))&&(!h.plainLyrics||0>=(null===(b=h.plainLyrics)||void 0===b?void 0:b.length)))return this.infoLog("The fetched song does not have lyrics [LRCLIB]"),
null;this.infoLog("Successfully fetched and cached the lyrics [LRCLIB]");return{source:"lrclib.net",plain:null===h||void 0===h?void 0:h.plainLyrics,lineSynced:null===h||void 0===h?void 0:h.syncedLyrics,wordSynced:null}}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [LRCLIB]",e),null}})}fetchLyricsMusixmatch(a,f){return __awaiter(this,void 0,void 0,function*(){if(!a)return null;var d=yield this.getMusixmatchUsertoken();this.debugLog("Musixmatch token data:",d);if(!d)return null;
this.infoLog(`Fetching the lyrics for "${a.track}" from "${a.album}" from "${a.artist}" (${this._trackId}) [Musixmatch]`);const b=yield this._searchLyricsMusixmatch(a,d);if(!b||!b.hasLyrics&&!b.hasLineSyncedLyrics&&!b.hasWordSyncedLyrics||!b.commonTrackId&&!b.trackId)return this.infoLog("Missing both commontrack_id and track_id [Musixmatch - Search]"),null;d=yield this._fetchLyricsMusixmatch(a,d,b.trackId,b.commonTrackId,b.hasLyrics,b.hasLineSyncedLyrics,b.hasWordSyncedLyrics,f);return Object.assign({source:"Musixmatch"},
d)})}fetchLyricsNetease(a,f){return __awaiter(this,void 0,void 0,function*(){if(!a||!f.includes("lineSynced"))return null;const d=yield this._searchLyricsNetease(a);return d?{source:"Netease",lineSynced:yield this._fetchLyricsNetease(a,d),plain:null,wordSynced:null}:(this.infoLog("Missing track ID [Netease - Search]"),null)})}_getLyrics(a,f){return __awaiter(this,void 0,void 0,function*(){const d={musixmatch:["plain","line","word"],lrclib:["plain","line"],netease:["line"]},b={musixmatch:this.fetchLyricsMusixmatch,
lrclib:this.fetchLyricsLrclib,netease:this.fetchLyricsNetease};var c=this.sources||["musixmatch","lrclib","netease"];const e={plain:{source:null,lyrics:null},lineSynced:{source:null,lyrics:null},wordSynced:{source:null,lyrics:null}};if(this._fetching)return e;this._fetching=!0;c.every(g=>!Object.keys(b).includes(g))&&(c=["musixmatch","lrclib","netease"]);a:for(const g of c){this.infoLog(`Trying to fetch the lyrics from the source "${g}"`);if(!("musixmatch"!==g||this.saveMusixmatchToken&&this.getMusixmatchToken)){this.infoLog("Musixmatch token functions are not avaible, skipping...");
continue}c=0;const h=d[g];for(const l of h)if("plain"!==l||!e.plain.lyrics&&f.includes("plain")||c++,"line"!==l||!e.lineSynced.lyrics&&f.includes("lineSynced")||c++,"word"!==l||!e.wordSynced.lyrics&&f.includes("wordSynced")||c++,c>=h.length)continue a;if(Object.keys(b).includes(g)){if(c=yield b[g](a,f))(null===c||void 0===c?0:c.plain)&&!e.plain.lyrics&&(e.plain.lyrics=c.plain,e.plain.source=c.source),(null===c||void 0===c?0:c.lineSynced)&&!e.lineSynced.lyrics&&(e.lineSynced.lyrics=c.lineSynced,e.lineSynced.source=
c.source),(null===c||void 0===c?0:c.wordSynced)&&!e.wordSynced.lyrics&&(e.wordSynced.lyrics=c.wordSynced,e.wordSynced.source=c.source)}else this.infoLog(`The source "${g}" doesn't exist, skipping...`)}this._fetching=!1;return e})}getLyrics(a,f){return __awaiter(this,void 0,void 0,function*(){if(!((null===a||void 0===a?0:a.track)||(null===a||void 0===a?0:a.artist)||(null===a||void 0===a?0:a.album)||(null===a||void 0===a?0:a.trackId)))throw Error("SyncLyrics (getlyrics): At least one of track, artist, album or trackId must be present");
this._trackId=a.trackId||btoa(unescape(encodeURIComponent(`${a.track||""}----${a.artist||""}----${a.album||""}`)));var d=Array.isArray(a.lyricsType)?a.lyricsType:["plain","lineSynced","wordSynced"];0>=d.length&&(d=["plain","lineSynced","wordSynced"]);var b=f?null:this.cache.get(this._trackId);if(a.trackId&&!b){var c=atob(a.trackId).split("----");b=c.shift()||"";const e=c.shift()||"";c=c.shift()||"";return yield this.getLyrics({track:b,artist:e,album:c,lyricsType:d},f)}d=b||(yield this._getLyrics(a,
d));!f&&(!this.cache.has(this._trackId)||(null===d||void 0===d?0:d.plain.lyrics)&&(null===b||void 0===b||!b.plain.lyrics)||(null===d||void 0===d?0:d.lineSynced.lyrics)&&(null===b||void 0===b||!b.lineSynced.lyrics)||(null===d||void 0===d?0:d.wordSynced.lyrics)&&(null===b||void 0===b||!b.wordSynced.lyrics))&&this.cache.set(this._trackId,d||{plain:{lyrics:null,source:null},lineSynced:{lyrics:null,source:null},wordSynced:{lyrics:null,source:null}});if(!d)return{trackId:this._trackId,lyrics:{plain:{lyrics:null,
source:null},lineSynced:{lyrics:null,source:null,parse:this.parseLyrics},wordSynced:{lyrics:null,source:null}},track:a.track,artist:a.artist,album:a.album,cached:!1};this.lyrics=d.lineSynced.lyrics;return{trackId:this._trackId,lyrics:Object.assign(Object.assign({},d),{lineSynced:Object.assign(Object.assign({},d.lineSynced),{parse:this.parseLyrics})}),track:a.track,artist:a.artist,album:a.album,cached:!!b}})}parseLyrics(a=this.lyrics){a=null===a||void 0===a?void 0:a.split("\n");if(!a)return null;const f=
[];let d;for(const g in a){var b=a[g].split(" ");const h=b.shift().replace(/[\[\]]/g,"");b=b.join(" ");var c=h.split(":")[0],e=h.split(":")[1];c=60*Number.parseFloat(c)+Number.parseFloat(e);e=this.instrumentalLyricsIndicator||"\uf001 ";"0"===g&&3<c&&e&&f.push({time:0,text:e});0<b.length?(d=h,f.push({time:c,text:b})):e&&(!d||3<d-h)&&(d=h,f.push({time:c,text:e}))}return f}getTrackId(a){return a.trackId?a.trackId:btoa(unescape(encodeURIComponent(`${a.track||""}----${a.artist||""}----${a.album||""}`)))}setLogLevel(a){if(!a)return this.logLevel=
"none",this;if(!Object.keys(exports.logLevels).includes(a))throw Error(`SyncLyrics: logLevel must be one of "${Object.keys(exports.logLevels).join('" | "')}"`);this.logLevel=a;return this}setInstrumentalLyricsIndicator(a){if(!a)return this.instrumentalLyricsIndicator="\uf001",this;if("string"!==typeof a)throw Error("SyncLyrics: instrumentalLyricsIndicator must be a string");this.instrumentalLyricsIndicator=a;return this}setSources(a){if(!a)return this.sources=["musixmatch","lrclib","netease"],this;
if(!Array.isArray(a)||0>=a.length)throw Error('SyncLyrics: sources must be an array with atleast one of "musixmatch" | "lrclib" | "netease"');this.sources=a;return this}setCache(a){if(!a)return this.cache=new Map,this;if("function"!==typeof a.get||"function"!==typeof a.set||"function"!==typeof a.has)throw Error("SyncLyrics: cache must have .get, .set and .has methods");this.cache=a;return this}setSaveMusixmatchToken(a){if("function"!==typeof a)throw Error("SyncLyrics: saveMusixmatchToken must be a function");
this.saveMusixmatchToken=a;return this}setGetMusixmatchToken(a){if("function"!==typeof a)throw Error("SyncLyrics: getMusixmatchToken must be a function");this.getMusixmatchToken=a;return this}warnLog(...a){(exports.logLevels[this.logLevel]||0)<exports.logLevels.warn||console.warn("\u001b[33;1mWARNING:\u001b[0m",...a)}debugLog(...a){(exports.logLevels[this.logLevel]||0)<exports.logLevels.debug||console.debug("\u001b[35;1mDEBUG:\u001b[0m",...a)}errorLog(...a){(exports.logLevels[this.logLevel]||0)<exports.logLevels.debug||
console.debug("\u001b[35;1mDEBUG:\u001b[0m",...a)}infoLog(...a){(exports.logLevels[this.logLevel]||0)<exports.logLevels.info||console.info("\u001b[34;1mINFO:\u001b[0m",...a)}}exports.SyncLyrics=SyncLyrics;
function normalize(a){return a.replace(/\uff08/g,"(").replace(/\uff09/g,")").replace(/\u3010/g,"[").replace(/\u3011/g,"]").replace(/\u3002/g,". ").replace(/\uff1b/g,"; ").replace(/\uff1a/g,": ").replace(/\uff1f/g,"? ").replace(/\uff01/g,"! ").replace(/\u3001|\uff0c/g,", ").replace(/\u2018|\u2019|\u2032|\uff07/g,"'").replace(/\u201c|\u201d/g,'"').replace(/\u301c/g,"~").replace(/\u00b7|\u30fb/g,"\u2022").replace(/\s+/g," ").trim()};
