"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,s){function o(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,i){function r(e){try{a(s.next(e))}catch(e){i(e)}}function c(e){try{a(s.throw(e))}catch(e){i(e)}}function a(e){e.done?n(e.value):o(e.value).then(r,c)}a((s=s.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SyncLyrics=void 0,exports.normalize=normalize;const util_1=require("util"),sleep=(0,util_1.promisify)(setTimeout),logLevels={debug:4,error:3,warn:2,info:1,none:0};class SyncLyrics{constructor(e){if(this.logLevel=e?.logLevel||"none",this.instrumentalLyricsIndicator=e?.instrumentalLyricsIndicator||"ÔÄÅ",this.sources=e?.sources||["musixmatch","lrclib","netease"],this.cache=e?.cache||new Map,this.saveMusixmatchToken=e?.saveMusixmatchToken,this.getMusixmatchToken=e?.getMusixmatchToken,this.sources.length<=0)throw new Error("SyncLyrics: You must provide atleast one source");this.lyrics=null,this._fetching=!1,this._fetchingTrackId=null,this._fetchingSource=null,this._trackId=null,this._fetchLineSyncedLyricsMusixmatch=this._fetchLineSyncedLyricsMusixmatch.bind(this),this._fetchWordSyncedLyricsMusixmatch=this._fetchWordSyncedLyricsMusixmatch.bind(this),this._fetchPlainLyricsMusixmatch=this._fetchPlainLyricsMusixmatch.bind(this),this._searchLyricsMusixmatch=this._searchLyricsMusixmatch.bind(this),this._fetchLyricsMusixmatch=this._fetchLyricsMusixmatch.bind(this),this.getMusixmatchUsertoken=this.getMusixmatchUsertoken.bind(this),this.fetchLyricsMusixmatch=this.fetchLyricsMusixmatch.bind(this),this._searchLyricsNetease=this._searchLyricsNetease.bind(this),this._parseNeteaseLyrics=this._parseNeteaseLyrics.bind(this),this._fetchLyricsNetease=this._fetchLyricsNetease.bind(this),this.fetchLyricsNetease=this.fetchLyricsNetease.bind(this),this.fetchLyricsLrclib=this.fetchLyricsLrclib.bind(this),this.parseLyrics=this.parseLyrics.bind(this),this._getLyrics=this._getLyrics.bind(this),this.getTrackId=this.getTrackId.bind(this),this.getLyrics=this.getLyrics.bind(this),this.debugLog=this.debugLog.bind(this),this.errorLog=this.errorLog.bind(this),this.infoLog=this.infoLog.bind(this),this.warnLog=this.warnLog.bind(this)}getMusixmatchUsertoken(e){return __awaiter(this,void 0,void 0,function*(){var t,n,s,o,i,a;if(this.infoLog("Getting Musixmatch token..."),!this.saveMusixmatchToken||!this.getMusixmatchToken)return this.infoLog("Musixmatch token functions are not avaible, skipping..."),null;const r=yield this.getMusixmatchToken();if(r)return r;this.infoLog("Fetching the token from the API...");const c="https://apic-desktop.musixmatch.com/ws/1.1/token.get?user_language=en&app_id=web-desktop-app-v1.0";try{const l=yield fetch(c,{redirect:"manual",headers:{cookie:e}});if(l.status===301){this.debugLog("Successfully received the 'set-cookie' redirect response");const e=l.headers.getSetCookie().map(e=>e.split(";").shift()).filter(e=>e.split("=").pop()!=="unknown").join("; ");return this.debugLog("Re-fetching with the cookies..."),yield this.getMusixmatchUsertoken(e)}if(!l.ok)return this.warnLog(`The usertoken API request failed with the status ${l.status} (${l.statusText})`),null;const r=yield l.json();if(((n=(t=r?.message)===null||t===void 0?void 0:t.header)===null||n===void 0?void 0:n.status_code)===401&&((o=(s=r?.message)===null||s===void 0?void 0:s.header)===null||o===void 0?void 0:o.hint)==="captcha")return this.warnLog("Musixmatch usertoken endpoint is being ratelimited, retrying in 10 seconds..."),yield sleep(1e4),this.infoLog("Retrying to fetch the Musixmatch usertken..."),yield this.getMusixmatchUsertoken(e);const d=(a=(i=r?.message)===null||i===void 0?void 0:i.body)===null||a===void 0?void 0:a.user_token;if(!d)return this.infoLog("The API response did not include the usertoken"),null;const u={cookies:e,usertoken:d,expiresAt:new Date(Date.now()+10*60*1e3).getTime()};return yield this.saveMusixmatchToken(u),this.infoLog("Successfully fetched the usertoken"),u}catch{}})}_searchLyricsMusixmatch(e,t){return __awaiter(this,void 0,void 0,function*(){var n,s,o,i,a,r,c,l,d,u,h,m,f,p,g,v,b;if(!e||!t)return null;const y=Number.parseFloat(e.length)/1e3,_=new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:t.usertoken,q_track:e.track||"",q_artist:e.artist||"",q_album:e.album||"",page_size:20,page:1,q_duration:y||"",s_track_rating:"asc"}),j=`https://apic-desktop.musixmatch.com/ws/1.1/track.search?${_}`;try{this.debugLog("Musixmatch search fetch URL:",j);const w=yield fetch(j,{headers:{cookie:t.cookies}});if(!w.ok)return this.warnLog(`Lyrics fetch request failed with status ${w.status} (${w.statusText}) [Musixmatch - Search]`),null;const _=yield w.json();if(((p=(l=_?.message)===null||l===void 0?void 0:l.header)===null||p===void 0?void 0:p.status_code)===401&&((i=(o=_?.message)===null||o===void 0?void 0:o.header)===null||i===void 0?void 0:i.hint)==="captcha")return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha) [Musixmatch - Search]"),null;if(this.debugLog("Musixmatch search results:",(r=(a=_?.message)===null||a===void 0?void 0:a.body)===null||r===void 0?void 0:r.track_list),((d=(h=(c=_?.message)===null||c===void 0?void 0:c.body)===null||h===void 0?void 0:h.track_list)===null||d===void 0?void 0:d.length)<=0)return this.infoLog("No songs were found [Musixmatch - Search]"),null;const y=(m=(n=(u=_?.message)===null||u===void 0?void 0:u.body)===null||n===void 0?void 0:n.track_list)===null||m===void 0?void 0:m.find(t=>{var n,s,o,i;return((n=t.track.track_name)===null||n===void 0?void 0:n.toLowerCase())===((s=e.track)===null||s===void 0?void 0:s.toLowerCase())&&((o=t.track.artist_name)===null||o===void 0?void 0:o.toLowerCase().includes((i=e.artist)===null||i===void 0?void 0:i.toLowerCase()))});if(this.debugLog("Musixmatch search filtered track:",y),!y)return this.infoLog("No songs were found with the current name and artist [Musixmatch - Search]"),null;this.debugLog(y);const O=(f=y?.track)===null||f===void 0?void 0:f.commontrack_id,x=(s=y?.track)===null||s===void 0?void 0:s.track_id,C=(g=y?.track)===null||g===void 0?void 0:g.has_lyrics,E=(v=y?.track)===null||v===void 0?void 0:v.has_subtitles,k=(b=y?.track)===null||b===void 0?void 0:b.has_richsync;return!C&&!E&&!k?null:(this.debugLog("Musixmatch commontrack_id",O),this.debugLog("Musixmatch track_id",x),{commonTrackId:O,trackId:x,hasLyrics:C,hasLineSyncedLyrics:E,hasWordSyncedLyrics:k})}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Search]",e),null}})}_fetchPlainLyricsMusixmatch(e,t){return __awaiter(this,void 0,void 0,function*(){var n,s,o,i,a,r,c,l;if(!e||!t)return null;const u=new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:e.usertoken,commontrack_id:t}),d=`https://apic-desktop.musixmatch.com/ws/1.1/track.lyrics.get?${u}`;try{this.debugLog("Musixmatch lyrics fetch URL:",d);const u=yield fetch(d,{headers:{cookie:e.cookies}});if(!u.ok)return this.warnLog(`Lyrics fetch request failed with status ${u.status} (${u.statusText}) [Musixmatch - Lyrics]`),null;const t=yield u.json();if(((s=(n=t?.message)===null||n===void 0?void 0:n.header)===null||s===void 0?void 0:s.status_code)===401&&((i=(o=t?.message)===null||o===void 0?void 0:o.header)===null||i===void 0?void 0:i.hint)==="captcha")return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Lyrics]"),null;this.debugLog("Musixmatch track data:",(a=t?.message)===null||a===void 0?void 0:a.body);const h=(l=(c=(r=t?.message)===null||r===void 0?void 0:r.body)===null||c===void 0?void 0:c.lyrics)===null||l===void 0?void 0:l.lyrics_body;return h?(this.infoLog("Successfully fetched and cached the plain lyrics [Musixmatch]"),h):(this.infoLog("Missing Lyrics [Musixmatch - Lyrics]"),null)}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Lyrics]",e),null}})}_fetchLineSyncedLyricsMusixmatch(e,t){return __awaiter(this,void 0,void 0,function*(){var n,s,o,i,a,r,c,l;if(!e||!t)return null;const u=new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:e.usertoken,commontrack_id:t}),d=`https://apic-desktop.musixmatch.com/ws/1.1/track.subtitle.get?${u}`;try{this.debugLog("Musixmatch synced lyrics fetch URL:",d);const u=yield fetch(d,{headers:{cookie:e.cookies}});if(!u.ok)return this.warnLog(`Lyrics fetch request failed with status ${u.status} (${u.statusText}) [Musixmatch - Synced Lyrics]`),null;const t=yield u.json();if(((s=(n=t?.message)===null||n===void 0?void 0:n.header)===null||s===void 0?void 0:s.status_code)===401&&((i=(o=t?.message)===null||o===void 0?void 0:o.header)===null||i===void 0?void 0:i.hint)==="captcha")return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Synced Lyrics]"),null;this.debugLog("Musixmatch track data:",(a=t?.message)===null||a===void 0?void 0:a.body);const h=(l=(c=(r=t?.message)===null||r===void 0?void 0:r.body)===null||c===void 0?void 0:c.subtitle)===null||l===void 0?void 0:l.subtitle_body;return h?(this.infoLog("Successfully fetched and cached the synced lyrics [Musixmatch]"),h):(this.infoLog("Missing Lyrics [Musixmatch - Synced Lyrics]"),null)}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Synced Lyrics]",e),null}})}_fetchWordSyncedLyricsMusixmatch(e,t){return __awaiter(this,void 0,void 0,function*(){var n,s,o,i,a,r,c,l;if(!e||!t)return null;const u=new URLSearchParams({app_id:"web-desktop-app-v1.0",usertoken:e.usertoken,track_id:t}),d=`https://apic-desktop.musixmatch.com/ws/1.1/track.richsync.get?${u}`;try{this.debugLog("Musixmatch lyrics fetch URL:",d);const h=yield fetch(d,{headers:{cookie:e.cookies}});if(!h.ok)return this.warnLog(`Lyrics fetch request failed with status ${h.status} (${h.statusText}) [Musixmatch - Word Synced Lyrics]`),null;const t=yield h.json();if(((s=(n=t?.message)===null||n===void 0?void 0:n.header)===null||s===void 0?void 0:s.status_code)===401&&((i=(o=t?.message)===null||o===void 0?void 0:o.header)===null||i===void 0?void 0:i.hint)==="captcha")return this.warnLog("The usertoken has been temporary blocked for too many requests (captcha)... [Musixmatch - Word Synced Lyrics]"),null;this.debugLog("Musixmatch track data:",(a=t?.message)===null||a===void 0?void 0:a.body);let u=(l=(c=(r=t?.message)===null||r===void 0?void 0:r.body)===null||c===void 0?void 0:c.richsync)===null||l===void 0?void 0:l.richsync_body;if(!u||u.length<=0)return this.infoLog("Missing Lyrics [Musixmatch - Word Synced Lyrics]"),null;u=JSON.parse(u);const m=u.map(e=>{const t=e.ts,n=e.te,s=e.x,o=e.l.map(e=>({character:e.c,time:e.o}));return{end:n,lyric:s,start:t,syncedLyric:o}});return this.infoLog("Successfully fetched and cached the synced lyrics [Musixmatch]"),m}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [Musixmatch - Word Synced Lyrics]",e),null}})}_fetchLyricsMusixmatch(e,t,n,s,o,i,a){return __awaiter(this,void 0,void 0,function*(){if(!e||!s&&!n||!t||!o&&!i&&!a)return null;const r={plain:null,lineSynced:null,wordSynced:null};return o&&s&&(r.plain=yield this._fetchPlainLyricsMusixmatch(t,s)),i&&s&&(r.lineSynced=yield this._fetchLineSyncedLyricsMusixmatch(t,s)),a&&s&&(r.wordSynced=yield this._fetchWordSyncedLyricsMusixmatch(t,n)),r})}_searchLyricsNetease(e){return __awaiter(this,void 0,void 0,function*(){var t,n,s,o,i;const r=new URLSearchParams({limit:10,type:1,keywords:`${e.track} ${e.artist}`}),a=`https://music.xianqiao.wang/neteaseapiv2/search?${r}`;try{this.debugLog("Netease search fetch URL:",a);const c=yield fetch(a,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0"}});if(!c.ok)return this.warnLog(`Lyrics fetch request failed with status ${c.status} (${c.statusText}) [Netease - Search]`),null;const r=yield c.json();if(!((t=r?.result)===null||t===void 0?void 0:t.songs)||((s=(n=r?.result)===null||n===void 0?void 0:n.songs)===null||s===void 0?void 0:s.length)<=0)return this.infoLog("No songs were found [Netease - Search]"),null;const l=(i=(o=r?.result)===null||o===void 0?void 0:o.songs)===null||i===void 0?void 0:i.find(t=>{var n,s;return((n=t.name)===null||n===void 0?void 0:n.toLowerCase())===((s=e.track)===null||s===void 0?void 0:s.toLowerCase())&&(t.artists.some(t=>{var n,s,o;return(s=(n=t.name)===null||n===void 0?void 0:n.toLowerCase())===null||s===void 0?void 0:s.includes((o=e.artist)===null||o===void 0?void 0:o.toLowerCase())})||t.artists.some(t=>{var n,s,o,i,a;return(o=(s=(n=t.name)===null||n===void 0?void 0:n.toLowerCase())===null||s===void 0?void 0:s.replace(/-/g," "))===null||o===void 0?void 0:o.includes((a=(i=e.artist)===null||i===void 0?void 0:i.toLowerCase())===null||a===void 0?void 0:a.replace(/-/g," "))}))});if(this.debugLog("Netease search filtered track:",l),!l)return this.infoLog("No songs were found with the current name and artist [Netease - Search]"),null;const d=l.id;return this.debugLog("Neteasw track ID",d),d}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [Netease - Search]",e),null}})}_fetchLyricsNetease(e,t){return __awaiter(this,void 0,void 0,function*(){var n;if(!e||!t)return null;const o=new URLSearchParams({id:t}),s=`https://music.xianqiao.wang/neteaseapiv2/lyric?${o}`;try{this.debugLog("Netease lyrics fetch URL:",s);const e=yield fetch(s,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0"}});if(!e.ok)return this.warnLog(`Lyrics fetch request failed with status ${e.status} (${e.statusText}) [Netease - Lyrics]`),null;const t=yield e.json();this.debugLog("Netease track data:",t);let o=(n=t?.lrc)===null||n===void 0?void 0:n.lyric;return o?(o=this._parseNeteaseLyrics(o),this.infoLog("Successfully fetched and cached the synced lyrics [Netease]"),o):(this.infoLog("Missing Lyrics [Netease - Lyrics]"),null)}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [Netease - Lyrics]",e),null}})}_parseNeteaseLyrics(e){const t=e.split(/\r?\n/).map(e=>e.trim()),n=[],s=["\\s?‰Ωú?\\s*ËØç|\\s?‰Ωú?\\s*Êõ≤|\\s?Áºñ\\s*Êõ≤?|\\s?Áõë\\s*Âà∂?",".*ÁºñÂÜô|.*ÂíåÈü≥|.*ÂíåÂ£∞|.*ÂêàÂ£∞|.*ÊèêÁê¥|.*ÂΩï|.*Â∑•Á®ã|.*Â∑•‰ΩúÂÆ§|.*ËÆæËÆ°|.*Ââ™Ëæë|.*Âà∂‰Ωú|.*ÂèëË°å|.*Âá∫ÂìÅ|.*ÂêéÊúü|.*Ê∑∑Èü≥|.*Áº©Ê∑∑","ÂéüÂî±|ÁøªÂî±|È¢òÂ≠ó|ÊñáÊ°à|Êµ∑Êä•|Âè§Á≠ù|‰∫åËÉ°|Èí¢Áê¥|Âêâ‰ªñ|Ë¥ùÊñØ|Á¨õÂ≠ê|Èºì|Âº¶‰πê| ‰∫∫Â£∞ ","lrc|publish|vocal|guitar|program|produce|write|mix"],o=new RegExp(`^(${s.join("|")}).*(:|Ôºö)`,"i");for(let i=0;i<t.length;i++){const r=t[i],e=r.match(/(\[.*?\])|([^[\]]+)/g);if(!e||e.length===1)continue;let a=-1;for(let t=0;t<e.length;t++)if(!e[t].endsWith("]")){a=t;break}let s="";a>-1&&(s=e.splice(a,1)[0],s=s.charAt(0).toUpperCase()+normalize(s.slice(1)));const c=e[0];o.test(s)||n.push(`${c} ${s||""}`)}return n.join(`
`)}fetchLyricsLrclib(e){return __awaiter(this,void 0,void 0,function*(){var t,n;if(!e)return;this.infoLog(`Fetching the lyrics for "${e.track}" from "${e.album}" from "${e.artist}" (${this._trackId}) [LRCLIB]`);const s=new URLSearchParams({track_name:e.track,artist_name:e.artist,album_name:e.album,q:e.track}),o=`https://lrclib.net/api/search?${s}`;try{const i=yield fetch(o,{headers:{"Lrclib-Client":"SyncLyrics (https://github.com/Stef-00012/SyncLyrics)","User-Agent":"SyncLyrics (https://github.com/Stef-00012/SyncLyrics)"}});if(!i.ok)return this.warnLog(`Lyrics fetch request failed with status ${i.status} (${i.statusText}) [LRCLIB]`),null;const a=yield i.json();this.debugLog("lrclib.net results:",a);const s=a.find(t=>{var n,s,o,i;return((n=t.artistName)===null||n===void 0?void 0:n.toLowerCase().includes((s=e.artist)===null||s===void 0?void 0:s.toLowerCase()))&&((o=t.trackName)===null||o===void 0?void 0:o.toLowerCase())===((i=e.track)===null||i===void 0?void 0:i.toLowerCase())});return this.debugLog("lrclib filtered track:",s),!s||(!s.syncedLyrics||((t=s.syncedLyrics)===null||t===void 0?void 0:t.length)<=0)&&(!s.plainLyrics||((n=s.plainLyrics)===null||n===void 0?void 0:n.length)<=0)?(this.infoLog("The fetched song does not have lyrics [LRCLIB]"),null):(this.infoLog("Successfully fetched and cached the lyrics [LRCLIB]"),{source:"lrclib.net",plain:s?.plainLyrics,lineSynced:s?.syncedLyrics,wordSynced:null})}catch(e){return this.errorLog("Something went wrong while fetching the lyrics [LRCLIB]",e),null}})}fetchLyricsMusixmatch(e){return __awaiter(this,void 0,void 0,function*(){if(!e)return;const n=yield this.getMusixmatchUsertoken();if(this.debugLog("Musixmatch token data:",n),!n)return null;this.infoLog(`Fetching the lyrics for "${e.track}" from "${e.album}" from "${e.artist}" (${this._trackId}) [Musixmatch]`);const t=yield this._searchLyricsMusixmatch(e,n);if(!t||!t.hasLyrics&&!t.hasLineSyncedLyrics&&!t.hasWordSyncedLyrics||!t.commonTrackId&&!t.trackId)return this.infoLog("Missing both commontrack_id and track_id [Musixmatch - Search]"),null;const s=yield this._fetchLyricsMusixmatch(e,n,t.trackId,t.commonTrackId,t.hasLyrics,t.hasLineSyncedLyrics,t.hasWordSyncedLyrics);return Object.assign({source:"Musixmatch"},s)})}fetchLyricsNetease(e){return __awaiter(this,void 0,void 0,function*(){if(!e)return;const t=yield this._searchLyricsNetease(e);if(!t)return this.infoLog("Missing track ID [Netease - Search]"),null;const n=yield this._fetchLyricsNetease(e,t);return{source:"Netease",lineSynced:n,plain:null,wordSynced:null}})}_getLyrics(e){return __awaiter(this,void 0,void 0,function*(){if(this._fetching&&this._fetchingTrackId===this._trackId)return this.warnLog(`Already fetching from the source "${this._fetchingSource}" (Track ID: "${this._fetchingTrackId}")`),null;const o={musixmatch:["plain","line","word"],lrclib:["plain","line"],netease:["line"]},n={musixmatch:this.fetchLyricsMusixmatch,lrclib:this.fetchLyricsLrclib,netease:this.fetchLyricsNetease};let s=this.sources||["musixmatch","lrclib","netease"];const t={plain:{source:null,lyrics:null},lineSynced:{source:null,lyrics:null},wordSynced:{source:null,lyrics:null}};s.every(e=>!Object.keys(n).includes(e))&&(s=["musixmatch","lrclib","netease"]);sourcesLoop:for(const a of s){if(this.infoLog(`Trying to fetch the lyrics from the source "${a}"`),a==="musixmatch"&&(!this.saveMusixmatchToken||!this.getMusixmatchToken)){this.infoLog("Musixmatch token functions are not avaible, skipping...");continue}let r=0;const c=o[a];for(const e of c)if(e==="plain"&&t.plain.lyrics&&r++,e==="line"&&t.lineSynced.lyrics&&r++,e==="word"&&t.wordSynced.lyrics&&r++,r>=c.length)continue sourcesLoop;if(!Object.keys(n).includes(a)){this.infoLog(`The source "${a}" doesn't exist, skipping...`);continue}this._fetching=!0,this._fetchingSource=a,this._fetchingTrackId=this._trackId;const i=yield n[a](e);if(!i)continue;i?.plain&&!t.plain.lyrics&&(t.plain.lyrics=i.plain,t.plain.source=i.source),i?.lineSynced&&!t.lineSynced.lyrics&&(t.lineSynced.lyrics=i.lineSynced,t.lineSynced.source=i.source),i?.wordSynced&&!t.wordSynced.lyrics&&(t.wordSynced.lyrics=i.wordSynced,t.wordSynced.source=i.source)}return t})}getLyrics(e,t){return __awaiter(this,void 0,void 0,function*(){if(!e?.track&&!e?.artist&&!e?.album&&!e?.trackId)throw new Error("SyncLyrics (getlyrics): At least one of track, artist, album or trackId must be present");this._trackId=e.trackId||btoa(unescape(encodeURIComponent(`${e.track||""}-${e.artist||""}-${e.album||""}`)));const s=t?null:this.cache.get(this._trackId),n=s||(yield this._getLyrics(e));return!t&&(!this.cache.has(this._trackId)||n?.plain.lyrics&&!s?.plain.lyrics||n?.lineSynced.lyrics&&!s?.lineSynced.lyrics||n?.wordSynced.lyrics&&!s?.wordSynced.lyrics)&&this.cache.set(this._trackId,n||{plain:{lyrics:null,source:null},lineSynced:{lyrics:null,source:null},wordSynced:{lyrics:null,source:null}}),n?(this.lyrics=n.lineSynced.lyrics,{trackId:this._trackId,lyrics:Object.assign(Object.assign({},n),{lineSynced:Object.assign(Object.assign({},n.lineSynced),{parse:this.parseLyrics})}),track:e.track,artist:e.artist,album:e.album,cached:!!s}):{trackId:this._trackId,lyrics:{plain:{lyrics:null,source:null},lineSynced:{lyrics:null,source:null,parse:this.parseLyrics},wordSynced:{lyrics:null,source:null}},track:e.track,artist:e.artist,album:e.album,cached:!1}})}parseLyrics(e=this.lyrics){const s=e?.split(`
`);if(!s)return null;const t=[];let n;for(const a in s){const r=s[a].split(" "),e=r.shift().replace(/[[\]]/g,""),c=r.join(" "),l=e.split(":")[0],d=e.split(":")[1],i=Number.parseFloat(l)*60+Number.parseFloat(d),o=this.instrumentalLyricsIndicator||"ÔÄÅ ";if(a==="0"&&i>3&&o&&t.push({time:0,text:o}),c.length>0){n=e,t.push({time:i,text:c});continue}o&&(!n||n-e>3)&&(n=e,t.push({time:i,text:o}))}return t}getTrackId(e){return e.trackId?e.trackId:btoa(unescape(encodeURIComponent(`${e.track||""}-${e.artist||""}-${e.album||""}`)))}warnLog(...e){if((logLevels[this.logLevel]||0)<logLevels.warn)return;console.warn("[33;1mWARNING:[0m",...e)}debugLog(...e){if((logLevels[this.logLevel]||0)<logLevels.debug)return;console.debug("[35;1mDEBUG:[0m",...e)}errorLog(...e){if((logLevels[this.logLevel]||0)<logLevels.debug)return;console.debug("[35;1mDEBUG:[0m",...e)}infoLog(...e){if((logLevels[this.logLevel]||0)<logLevels.info)return;console.info("[34;1mINFO:[0m",...e)}}exports.SyncLyrics=SyncLyrics;function normalize(e){return e.replace(/Ôºà/g,"(").replace(/Ôºâ/g,")").replace(/„Äê/g,"[").replace(/„Äë/g,"]").replace(/„ÄÇ/g,". ").replace(/Ôºõ/g,"; ").replace(/Ôºö/g,": ").replace(/Ôºü/g,"? ").replace(/ÔºÅ/g,"! ").replace(/„ÄÅ|Ôºå/g,", ").replace(/‚Äò|‚Äô|‚Ä≤|Ôºá/g,"'").replace(/‚Äú|‚Äù/g,'"').replace(/„Äú/g,"~").replace(/¬∑|„Éª/g,"‚Ä¢").replace(/\s+/g," ").trim()}